<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Portfolio Overview</title>
<style>
  table { border-collapse: collapse; width: 100%; margin-bottom: 2rem; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
  th { cursor: pointer; background-color: #f0f0f0; }
  tfoot td { font-weight: bold; }
</style>
</head>
<body>

<h2>Options</h2>
<table id="options-table">
  <thead>
    <tr>
      <th>Ticker</th>
      <th>Weight %</th>
      <th>Expiry Date</th>
      <th>Strike Price</th>
      <th>Opening Price</th>
      <th>Upside %</th>
      <th>Weighted Lost Upside %</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<h2>Stocks</h2>
<table id="stocks-table">
  <thead>
    <tr>
      <th>Ticker</th>
      <th>Weight %</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<h2>Cash</h2>
<table id="cash-table">
  <thead>
    <tr>
      <th>Ticker</th>
      <th>Weight %</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const buckets = [
  { id: 'options', file: 'data/JEPQ_Options_-_Index_latest.json' },
  { id: 'stocks', file: 'data/JEPQ_Stocks_latest.json' },
  { id: 'cash', file: 'data/JEPQ_Cash_latest.json' }
];

function sortTable(table, colIndex, numeric = false) {
  const tbody = table.tBodies[0];
  Array.from(tbody.rows)
    .sort((a, b) => {
      let valA = numeric ? parseFloat(a.cells[colIndex].textContent.replace('%','')) : a.cells[colIndex].textContent;
      let valB = numeric ? parseFloat(b.cells[colIndex].textContent.replace('%','')) : b.cells[colIndex].textContent;
      return valA > valB ? 1 : valA < valB ? -1 : 0;
    })
    .forEach(row => tbody.appendChild(row));
}

buckets.forEach(bucket => {
  fetch(bucket.file)
    .then(res => res.json())
    .then(data => {
      const table = document.querySelector(`#${bucket.id}-table`);
      const tbody = table.querySelector('tbody');
      const tfoot = document.createElement('tfoot');
      tbody.innerHTML = '';

      if (data.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = bucket.id === 'options' ? 7 : 2;
        td.textContent = "No records available";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      let sumWeight = 0;
      let sumLostUpside = 0;

      data.forEach(item => {
        const tr = document.createElement('tr');
        if (bucket.id === 'options') {
          const [day, month, year] = item.Expiry_Date.split('/');
          const displayDate = `${day}/${month}/${year}`;
          const strike = parseFloat(item.Strike_Price.replace(/,/g, ''));
          const opening = parseFloat(item.OpeningPrice);
          const upside = (strike - opening) / opening * 100;
          const weight = parseFloat(item.Weight);
          const lostUpside = weight * upside;

          sumWeight += weight;
          sumLostUpside += lostUpside;

          // Color coding
          let color = '';
          if (opening < strike) color = 'green';
          else if (opening > strike) color = 'red';
          else color = 'yellow';
          tr.style.backgroundColor = color;

          tr.innerHTML = `
            <td>${item.Ticker}</td>
            <td>${(weight*100).toFixed(2)}%</td>
            <td data-value="${item.Expiry_Date}">${displayDate}</td>
            <td>${item.Strike_Price}</td>
            <td>${item.OpeningPrice}</td>
            <td>${upside.toFixed(2)}%</td>
            <td>${lostUpside.toFixed(2)}%</td>
          `;
        } else {
          const weight = parseFloat(item.Weight);
          sumWeight += weight;
          tr.innerHTML = `
            <td>${item.Ticker}</td>
            <td>${(weight*100).toFixed(2)}%</td>
          `;
        }
        tbody.appendChild(tr);
      });

      // Footer
      const footerTr = document.createElement('tr');
      footerTr.style.fontWeight = 'bold';
      if (bucket.id === 'options') {
        footerTr.innerHTML = `
          <td>Total</td>
          <td>${(sumWeight*100).toFixed(2)}%</td>
          <td colspan="4"></td>
          <td>${sumLostUpside.toFixed(2)}%</td>
        `;
      } else {
        footerTr.innerHTML = `
          <td>Total</td>
          <td>${(sumWeight*100).toFixed(2)}%</td>
        `;
      }
      tfoot.appendChild(footerTr);
      table.appendChild(tfoot);

      // Make headers sortable
      Array.from(table.querySelectorAll('th')).forEach((th, index) => {
        th.addEventListener('click', () => sortTable(table, index, index !== 0));
      });

    })
    .catch(err => console.error(`Failed to load ${bucket.file}:`, err));
});
</script>

</body>
</html>
